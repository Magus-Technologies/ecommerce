<div class="modal-overlay" *ngIf="isVisible" (click)="cerrarModal()">
  <div class="modal-container-wide" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ mode === 'edit' ? 'Editar Usuario' : 'Ver Usuario' }}</h2>
      <button class="btn-close" (click)="cerrarModal()">
        <i class="ph ph-x"></i>
      </button>
    </div>

    <div class="modal-body" *ngIf="!loading">
      <form [formGroup]="usuarioForm" (ngSubmit)="onSubmit()" [class.view-only]="mode === 'view'">

        <div class="row">
          <!-- Columna Izquierda -->
          <div class="col-md-6">
            <!-- Información básica -->
            <div class="form-section">
              <h3 class="section-title">
                <i class="ph ph-user"></i>
                Información Básica
              </h3>
              <div class="form-group">
                <label>Nombre de usuario</label>
                <input
                  type="text"
                  formControlName="name"
                  [readonly]="mode === 'view'"
                  class="form-control">
              </div>
              <div class="form-group">
                <label>Email</label>
                <input
                  type="email"
                  formControlName="email"
                  [readonly]="mode === 'view'"
                  class="form-control">
              </div>
              <div class="form-group">
                <label>Rol</label>
                <select
                  formControlName="role_id"
                  [disabled]="mode === 'view'"
                  class="form-control">
                  <option value="">Seleccionar rol</option>
                  <option *ngFor="let rol of roles" [value]="rol.id">
                    {{ rol.name }}
                  </option>
                </select>
              </div>
            </div>

            <!-- Avatar -->
            <div class="form-section">
              <h3 class="section-title">
                <i class="ph ph-image"></i>
                Foto de Perfil
              </h3>
              <div class="avatar-container-centered">
                <div class="avatar-preview-large">
                  <img
                    *ngIf="previewUrl && !removeAvatar"
                    [src]="previewUrl"
                    alt="Avatar">
                  <div
                    *ngIf="!previewUrl || removeAvatar"
                    class="avatar-placeholder-large"
                    [style.background-color]="getAvatarColor(usuarioForm.get('name')?.value || '')">
                    {{ getInitials(usuarioForm.get('name')?.value || '') }}
                  </div>
                </div>
                <div class="avatar-actions" *ngIf="mode === 'edit'">
                  <input
                    type="file"
                    #fileInput
                    (change)="onFileSelected($event)"
                    accept="image/*"
                    style="display: none;">
                  <button
                    type="button"
                    class="btn btn-sm btn-primary me-2"
                    (click)="fileInput.click()">
                    <i class="ph ph-camera"></i>
                    Cambiar Foto
                  </button>
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-danger"
                    (click)="onRemoveAvatar()"
                    *ngIf="previewUrl && !removeAvatar">
                    <i class="ph ph-trash"></i>
                    Eliminar
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Columna Derecha -->
          <div class="col-md-6">
            <!-- Perfil Personal -->
            <div class="form-section" formGroupName="profile">
              <h3 class="section-title">
                <i class="ph ph-identification-card"></i>
                Perfil Personal
              </h3>

              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label>Primer Nombre</label>
                    <input
                      type="text"
                      formControlName="first_name"
                      [readonly]="mode === 'view'"
                      class="form-control">
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label>Apellido Paterno</label>
                    <input
                      type="text"
                      formControlName="last_name_father"
                      [readonly]="mode === 'view'"
                      class="form-control">
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label>Apellido Materno</label>
                    <input
                      type="text"
                      formControlName="last_name_mother"
                      [readonly]="mode === 'view'"
                      class="form-control">
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label>Teléfono</label>
                    <input
                      type="text"
                      formControlName="phone"
                      [readonly]="mode === 'view'"
                      class="form-control">
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label>Tipo de Documento</label>
                    <select
                      formControlName="document_type"
                      [disabled]="mode === 'view'"
                      class="form-control">
                      <option value="">Seleccionar tipo</option>
                      <option *ngFor="let tipo of tiposDocumento" [value]="tipo.id">
                        {{ tipo.nombre }}
                      </option>
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label>Número de Documento</label>
                    <input
                      type="text"
                      formControlName="document_number"
                      [readonly]="mode === 'view'"
                      class="form-control">
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label>Fecha de Nacimiento</label>
                    <input
                      type="date"
                      formControlName="birth_date"
                      [readonly]="mode === 'view'"
                      class="form-control">
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label>Género</label>
                    <select
                      formControlName="genero"
                      [disabled]="mode === 'view'"
                      class="form-control">
                      <option value="">Seleccionar género</option>
                      <option value="masculino">Masculino</option>
                      <option value="femenino">Femenino</option>
                      <option value="otro">Otro</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Direcciones en su propia fila -->
        <div class="row" *ngIf="addressesArray.length > 0">
          <div class="col-12">
            <div class="form-section">
              <h3 class="section-title">
                <i class="ph ph-map-pin"></i>
                Direcciones
                <span class="badge bg-main-50 text-main-600 ms-2">{{ addressesArray.length }}</span>
              </h3>

              <div formArrayName="addresses">
                <div class="row">
                  <div
                    *ngFor="let address of addressesArray.controls; let i = index"
                    class="col-md-6 mb-3">
                    <div
                      [formGroupName]="i"
                      class="address-card">

                      <div class="address-header">
                        <h5 class="address-title">
                          <i class="ph ph-house"></i>
                          {{ address.get('label')?.value || 'Dirección ' + (i + 1) }}
                          <span
                            *ngIf="address.get('is_default')?.value"
                            class="badge bg-success-50 text-success-600 ms-2">
                            Principal
                          </span>
                        </h5>
                        <div class="address-actions" *ngIf="mode === 'edit'">
                          <button
                            type="button"
                            class="btn btn-xs btn-outline-success"
                            (click)="marcarComoPrincipal(i)"
                            [class.active]="address.get('is_default')?.value"
                            title="Marcar como principal">
                            <i class="ph ph-star"></i>
                          </button>
                          <button
                            type="button"
                            class="btn btn-xs btn-outline-danger"
                            (click)="eliminarDireccion(i)"
                            [disabled]="addressesArray.length <= 1"
                            title="Eliminar dirección">
                            <i class="ph ph-trash"></i>
                          </button>
                        </div>
                      </div>

                      <div class="address-details">
                        <div class="form-group form-group-sm">
                          <label>Etiqueta</label>
                          <input
                            type="text"
                            formControlName="label"
                            [readonly]="mode === 'view'"
                            placeholder="Ej: Casa, Oficina"
                            class="form-control form-control-sm">
                        </div>

                        <div class="form-group form-group-sm">
                          <label>Dirección</label>
                          <input
                            type="text"
                            formControlName="address_line"
                            [readonly]="mode === 'view'"
                            placeholder="Ej: Av. Los Libertadores 123, Casa 5"
                            class="form-control form-control-sm">
                        </div>

                        <div class="row">
                          <div class="col-md-6">
                            <div class="form-group form-group-sm">
                              <label>Departamento</label>
                              <select
                                formControlName="department"
                                [disabled]="mode === 'view'"
                                (change)="onDepartamentoChange($event, i)"
                                class="form-control form-control-sm">
                                <option value="">Seleccionar</option>
                                <option *ngFor="let dept of departamentos" [value]="dept.id_ubigeo">
                                  {{ dept.nombre }}
                                </option>
                              </select>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="form-group form-group-sm">
                              <label>Provincia</label>
                              <select
                                formControlName="province"
                                [disabled]="mode === 'view'"
                                (change)="onProvinciaChange($event, i)"
                                class="form-control form-control-sm">
                                <option value="">Seleccionar</option>
                                <option *ngFor="let prov of getProvincesForAddress(i)" [value]="prov.id_ubigeo">
                                  {{ prov.nombre }}
                                </option>
                              </select>
                            </div>
                          </div>
                        </div>

                        <div class="row">
                          <div class="col-md-6">
                            <div class="form-group form-group-sm">
                              <label>Distrito</label>
                              <select
                                formControlName="city"
                                [disabled]="mode === 'view'"
                                class="form-control form-control-sm">
                                <option value="">Seleccionar</option>
                                <option *ngFor="let dist of getDistrictsForAddress(i)" [value]="dist.id_ubigeo">
                                  {{ dist.nombre }}
                                </option>
                              </select>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="form-group form-group-sm">
                              <label>Código Postal</label>
                              <input
                                type="text"
                                formControlName="postal_code"
                                [readonly]="mode === 'view'"
                                class="form-control form-control-sm">
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="mt-3" *ngIf="mode === 'edit'">
                <button
                  type="button"
                  class="btn btn-outline-primary"
                  (click)="agregarDireccion()">
                  <i class="ph ph-plus"></i>
                  Agregar Dirección
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="cerrarModal()">
            <i class="ph ph-x"></i>
            Cancelar
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="!usuarioForm.valid || loading"
            *ngIf="mode === 'edit'">
            <i class="ph ph-check" *ngIf="!loading"></i>
            <span class="spinner-border spinner-border-sm me-2" *ngIf="loading"></span>
            {{ loading ? 'Guardando...' : 'Guardar Cambios' }}
          </button>
        </div>
      </form>
    </div>

    <div class="modal-body loading-state" *ngIf="loading">
      <div class="text-center py-5">
        <div class="spinner-border text-primary mb-3" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="text-muted">Cargando información del usuario...</p>
      </div>
    </div>
  </div>
</div>