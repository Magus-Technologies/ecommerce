<div class="border border-gray-100 rounded-16 overflow-hidden bg-white">
  <!-- Header -->
  <div class="p-24 p-md-32 border-bottom border-gray-100">
    <div class="flex-between align-items-center gap-16 flex-wrap">
      <div>
        <h4 class="mb-4 text-heading">Gestión de Pedidos</h4>
        <p class="text-gray-500 mb-0 text-sm">
          Administra todas las cotizaciones/pedidos del sistema
        </p>
      </div>
    </div>
  </div>

  <!-- Filtros y Estadísticas -->
  <div class="p-24 p-md-32 border-bottom border-gray-100">
    <div class="row g-16">
      <div class="col-12 col-md-6 col-lg-7">
        <div class="position-relative">
          <i
            class="ph ph-magnifying-glass position-absolute start-0 top-50 translate-middle-y ms-12 text-gray-400"
          ></i>
          <input
            type="text"
            class="form-control ps-40"
            placeholder="Buscar por código, cliente o email..."
          />
        </div>
      </div>
      <div class="col-12 col-md-6 col-lg-5">
        <!-- Estadísticas en layout responsive -->
        <div
          class="d-flex align-items-center justify-content-start justify-content-md-end flex-wrap gap-8"
        >
          <div class="d-flex align-items-center gap-4">
            <span class="text-sm fw-medium text-dark">Total:</span>
            <span class="badge bg-main-50 text-main-600">{{
              cotizaciones.length
            }}</span>
          </div>
          <div class="d-flex align-items-center gap-4">
            <span class="text-sm fw-medium text-dark">Pendientes:</span>
            <span class="badge bg-warning-50 text-warning-600">{{
              getEstadisticaEstado("pendiente")
            }}</span>
          </div>
          <div class="d-flex align-items-center gap-4">
            <span class="text-sm fw-medium text-dark">Aprobadas:</span>
            <span class="badge bg-success-50 text-success-600">{{
              getEstadisticaEstado("aprobada")
            }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla Moderna usando clases globales -->
  <div class="modern-data-table mx-16 mb-24">
    <!-- Header compacto -->
    <div class="modern-data-table__header" *ngIf="!loading && cotizacionesFiltradas.length > 0">
      <div class="d-flex justify-content-between align-items-center">
        <span class="table-info">{{ cotizacionesFiltradas.length }} pedidos encontrados</span>
        <div class="d-flex align-items-center gap-2">
          <span style="font-size: var(--font-xs); color: var(--gray-500);">Filas:</span>
          <select class="page-size-selector" [(ngModel)]="pageSize" (change)="goToPage(1)">
            <option [value]="5">5</option>
            <option [value]="10">10</option>
            <option [value]="25">25</option>
            <option [value]="50">50</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Loading state -->
    <div *ngIf="loading" class="modern-data-table__loading">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="loading-text">Cargando pedidos...</p>
    </div>

    <!-- Tabla moderna -->
    <div class="modern-data-table__container" *ngIf="!loading">
      <table class="table table-borderless mb-0">
        <thead>
          <tr>
            <th>CÓDIGO</th>
            <th>CLIENTE</th>
            <th class="d-none d-lg-table-cell">FECHA</th>
            <th>TOTAL</th>
            <th class="d-none d-md-table-cell">ESTADO</th>
            <th class="text-end">ACCIONES</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let cotizacion of getPaginatedCotizaciones(); trackBy: trackByCotizacionId">
            <!-- Código -->
            <td>
              <div class="client-info__name">{{ cotizacion.codigo_cotizacion }}</div>
              <div class="client-info__subtitle">Cotización</div>
            </td>

            <!-- Cliente -->
            <td>
              <div class="d-flex align-items-center gap-12">
                <div class="table-avatar__circle" style="background-color: var(--main-600);">
                  {{ getInitials(cotizacion.cliente_nombre) }}
                </div>
                <div>
                  <div class="client-info__name">{{ cotizacion.cliente_nombre }}</div>
                  <div class="client-info__subtitle">{{ cotizacion.cliente_email }}</div>
                </div>
              </div>
            </td>

            <!-- Fecha (hidden on tablet) -->
            <td class="d-none d-lg-table-cell">
              <div class="date-info__main">{{ cotizacion.fecha_cotizacion | date:'dd/MM/yyyy' }}</div>
              <div class="date-info__relative">{{ cotizacion.fecha_cotizacion | date:'HH:mm' }}</div>
            </td>

            <!-- Total -->
            <td>
              <div class="pedido-total-info">
                <div class="total-amount">S/ {{ cotizacion.total | number:'1.2-2' }}</div>
                <div class="total-label">Total</div>
              </div>
            </td>

            <!-- Estado (hidden on mobile) -->
            <td class="d-none d-md-table-cell">
              <span class="status-badge" [ngClass]="getEstadoBadgeClass(cotizacion.estado_cotizacion?.nombre)">
                {{ cotizacion.estado_cotizacion?.nombre || 'Pendiente' }}
              </span>
            </td>

            <!-- Acciones -->
            <td class="text-end">
              <div class="action-buttons">
                <button class="action-buttons__btn action-buttons__btn--view"
                        (click)="verDetalle(cotizacion)"
                        title="Ver detalle">
                  <i class="ph ph-eye"></i>
                </button>
                <button class="action-buttons__btn action-buttons__btn--view"
                        style="background-color: var(--success-50) !important; color: var(--success-600) !important;"
                        (click)="contactarWhatsApp(cotizacion)"
                        title="Contactar WhatsApp">
                  <i class="ph ph-whatsapp-logo"></i>
                </button>
                <button class="action-buttons__btn action-buttons__btn--edit"
                        (click)="cambiarEstado(cotizacion)"
                        title="Cambiar estado">
                  <i class="ph ph-gear"></i>
                </button>
                <button class="action-buttons__btn action-buttons__btn--view"
                        style="background-color: var(--info-50) !important; color: var(--info-600) !important;"
                        (click)="imprimirPedido()"
                        title="Imprimir">
                  <i class="ph ph-printer"></i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Paginación moderna -->
    <div class="modern-data-table__pagination" *ngIf="!loading && cotizacionesFiltradas.length > 0 && getTotalPages() > 1">
      <div class="d-flex justify-content-between align-items-center">
        <div class="pagination-info">
          Mostrando {{ (currentPage - 1) * pageSize + 1 }} a {{ Math.min(currentPage * pageSize, cotizacionesFiltradas.length) }} de {{ cotizacionesFiltradas.length }} registros
        </div>
        <nav>
          <ul class="pagination-controls">
            <li [class.disabled]="currentPage === 1">
              <button (click)="goToPage(currentPage - 1)" [disabled]="currentPage === 1">
                <i class="ph ph-caret-left"></i>
              </button>
            </li>
            <li *ngFor="let page of getPageNumbers()" [class.active]="page === currentPage">
              <button (click)="goToPage(page)">{{ page }}</button>
            </li>
            <li [class.disabled]="currentPage === getTotalPages()">
              <button (click)="goToPage(currentPage + 1)" [disabled]="currentPage === getTotalPages()">
                <i class="ph ph-caret-right"></i>
              </button>
            </li>
          </ul>
        </nav>
      </div>
    </div>

    <!-- Estado vacío -->
    <div *ngIf="!loading && cotizaciones.length === 0" class="empty-state">
      <div class="empty-state__icon">
        <i class="ph ph-package"></i>
      </div>
      <h5 class="empty-state__title">No hay pedidos registrados</h5>
      <p class="empty-state__description">
        Aún no se han registrado cotizaciones/pedidos en el sistema.
      </p>
    </div>

    <!-- Sin resultados de búsqueda -->
    <div *ngIf="!loading && cotizaciones.length > 0 && cotizacionesFiltradas.length === 0" class="empty-state">
      <div class="empty-state__icon">
        <i class="ph ph-magnifying-glass"></i>
      </div>
      <h5 class="empty-state__title">No se encontraron resultados</h5>
      <p class="empty-state__description">
        Intenta cambiar los filtros para encontrar los pedidos que buscas.
      </p>
    </div>
  </div>
</div>

<!-- Modal de Detalle del Pedido -->
<div
  class="modal fade"
  id="detallePedidoModal"
  tabindex="-1"
  aria-hidden="true"
>
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          Detalle del Pedido {{ cotizacionSeleccionada?.codigo_cotizacion }}
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <!-- Información del Cliente -->
        <div class="card mb-3">
          <div class="card-header">
            <h6 class="mb-0">Información del Cliente</h6>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4">
                <p>
                  <strong>Nombre:</strong>
                  {{
                    cotizacionSeleccionada?.cliente_nombre ||
                      cotizacionSeleccionada?.user_cliente?.nombres +
                        " " +
                        cotizacionSeleccionada?.user_cliente?.apellidos
                  }}
                </p>
                <p>
                  <strong>Documento:</strong>
                  {{
                    cotizacionSeleccionada?.numero_documento ||
                      cotizacionSeleccionada?.user_cliente?.numero_documento
                  }}
                </p>
                <p>
                  <strong>Teléfono:</strong>
                  {{ cotizacionSeleccionada?.telefono_contacto }}
                </p>
              </div>
              <div class="col-md-4">
                <p>
                  <strong>Email:</strong>
                  {{
                    cotizacionSeleccionada?.cliente_email ||
                      cotizacionSeleccionada?.user_cliente?.email
                  }}
                </p>
                <p>
                  <strong>Dirección:</strong>
                  {{ cotizacionSeleccionada?.direccion_envio }}
                </p>
              </div>
              <div class="col-md-4">
                <p>
                  <strong>Ubicación:</strong>
                  {{
                    cotizacionSeleccionada?.ubicacion_completa ||
                      "No especificada"
                  }}
                </p>
                <p>
                  <strong>Departamento:</strong>
                  {{
                    cotizacionSeleccionada?.departamento_nombre ||
                      "No especificado"
                  }}
                </p>
                <p>
                  <strong>Provincia:</strong>
                  {{
                    cotizacionSeleccionada?.provincia_nombre ||
                      "No especificada"
                  }}
                </p>
                <p>
                  <strong>Distrito:</strong>
                  {{
                    cotizacionSeleccionada?.distrito_nombre || "No especificado"
                  }}
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Información del Pedido -->
        <div class="card mb-3">
          <div class="card-header">
            <h6 class="mb-0">Información del Pedido</h6>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4">
                <p>
                  <strong>Fecha:</strong>
                  {{
                    cotizacionSeleccionada?.fecha_cotizacion
                      | date : "dd/MM/yyyy HH:mm"
                  }}
                </p>
                <p>
                  <strong>Estado:</strong>
                  <span
                    class="badge px-12 py-6 rounded-pill fw-medium"
                    [class]="
                      getEstadoBadgeClass(
                        cotizacionSeleccionada?.estado_cotizacion?.nombre
                      )
                    "
                  >
                    {{
                      cotizacionSeleccionada?.estado_cotizacion?.nombre ||
                        "PENDIENTE"
                    }}
                  </span>
                </p>
                <p><strong>Tipo:</strong> Cotización</p>
              </div>
              <div class="col-md-4">
                <p>
                  <strong>Método de Pago Preferido:</strong>
                  {{
                    formatMetodoPago(
                      cotizacionSeleccionada?.metodo_pago_preferido
                    )
                  }}
                </p>
                <p>
                  <strong>Forma de Envío:</strong>
                  {{ formatFormaEnvio(cotizacionSeleccionada?.forma_envio) }}
                </p>
                <p>
                  <strong>Costo de Envío:</strong> S/
                  {{ cotizacionSeleccionada?.costo_envio || "0.00" }}
                </p>
              </div>
              <div class="col-md-4">
                <p>
                  <strong>Subtotal:</strong> S/
                  {{ cotizacionSeleccionada?.subtotal }}
                </p>
                <p>
                  <strong>IGV (18%):</strong> S/
                  {{ cotizacionSeleccionada?.igv }}
                </p>
                <p>
                  <strong>Total:</strong>
                  <span class="text-success fw-bold"
                    >S/ {{ cotizacionSeleccionada?.total }}</span
                  >
                </p>
              </div>
            </div>
            <div class="row" *ngIf="cotizacionSeleccionada?.observaciones">
              <div class="col-12">
                <p>
                  <strong>Observaciones:</strong>
                  {{ cotizacionSeleccionada?.observaciones }}
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Productos del Pedido -->
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0">Productos del Pedido</h6>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Imagen</th>
                    <th>Producto</th>
                    <th>Código</th>
                    <th>Cantidad</th>
                    <th>Precio Unit.</th>
                    <th>Subtotal</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let detalle of cotizacionSeleccionada?.detalles">
                    <td>
                      <img
                        [src]="detalle.imagen_url"
                        [alt]="detalle.nombre_producto"
                        class="img-thumbnail"
                        style="width: 50px; height: 50px; object-fit: cover"
                      />
                    </td>
                    <td>
                      <div class="fw-bold">{{ detalle.nombre_producto }}</div>
                      <small class="text-muted">{{
                        detalle.producto?.descripcion
                      }}</small>
                    </td>
                    <td>{{ detalle.codigo_producto }}</td>
                    <td>
                      <span class="badge bg-primary rounded-circle">{{
                        detalle.cantidad
                      }}</span>
                    </td>
                    <td>S/ {{ detalle.precio_unitario }}</td>
                    <td class="text-success-600 fw-bold">
                      S/ {{ detalle.subtotal_linea }}
                    </td>
                  </tr>
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="4"></td>
                    <td><strong>Total:</strong></td>
                    <td class="text-success-600 fw-bold">
                      S/ {{ cotizacionSeleccionada?.total }}
                    </td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cerrar
        </button>
        <button
          type="button"
          class="btn btn-primary"
          (click)="imprimirPedido()"
        >
          <i class="ph ph-printer me-2"></i>Imprimir
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Cambiar Estado -->
<div
  class="modal fade"
  id="cambiarEstadoModal"
  tabindex="-1"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="ph ph-gear me-2"></i>
          Cambiar Estado - {{ cotizacionSeleccionada?.codigo_cotizacion }}
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <!-- Información del Pedido -->
        <div class="card mb-3 bg-light">
          <div class="card-body p-3">
            <div class="row">
              <div class="col-md-6">
                <h6 class="fw-semibold mb-2">Información del Pedido:</h6>
                <p class="mb-1">
                  <strong>Cliente:</strong>
                  {{ cotizacionSeleccionada?.cliente_nombre }}
                </p>
                <p class="mb-1">
                  <strong>Forma de Envío:</strong>
                  <span
                    class="badge"
                    [class]="
                      cotizacionSeleccionada &&
                      esEnvioAProvincia(cotizacionSeleccionada)
                        ? 'bg-warning'
                        : 'bg-info'
                    "
                  >
                    {{ formatFormaEnvio(cotizacionSeleccionada?.forma_envio) }}
                  </span>
                </p>
              </div>
              <div class="col-md-6">
                <p class="mb-1">
                  <strong>Estado Actual:</strong>
                  <span
                    class="badge px-12 py-6 rounded-pill fw-medium"
                    [class]="
                      getEstadoBadgeClass(
                        cotizacionSeleccionada?.estado_cotizacion?.nombre
                      )
                    "
                  >
                    {{
                      cotizacionSeleccionada?.estado_cotizacion?.nombre ||
                        "Sin estado"
                    }}
                  </span>
                </p>
                <p class="mb-1">
                  <strong>Total:</strong> S/ {{ cotizacionSeleccionada?.total }}
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Alerta para pedidos a provincia -->
        <div
          *ngIf="
            cotizacionSeleccionada && esEnvioAProvincia(cotizacionSeleccionada)
          "
          class="alert alert-info d-flex align-items-center mb-3"
        >
          <i class="ph ph-info text-info me-2"></i>
          <small>
            <strong>Envío a Provincia:</strong>
            Este pedido sigue el flujo especial:
            <strong
              >Pendiente → En Recepción → Enviado a Provincia →
              Entregado</strong
            >
          </small>
        </div>

        <!-- Selector de Estado -->
        <div class="mb-3">
          <label class="form-label fw-semibold">Nuevo Estado *</label>
          <select class="form-select" [(ngModel)]="estadoSeleccionado">
            <option value="">Seleccione un estado...</option>
            <option
              *ngFor="let estado of estadosDisponibles"
              [value]="estado.id"
            >
              {{ estado.nombre }} - {{ estado.descripcion }}
            </option>
          </select>
          <div class="form-text">
            Solo se muestran los estados válidos para este tipo de envío
          </div>
        </div>

        <!-- Comentario -->
        <div class="mb-3">
          <label class="form-label fw-semibold">Comentario (Opcional)</label>
          <textarea
            class="form-control"
            rows="3"
            [(ngModel)]="comentarioEstado"
            placeholder="Agregar comentario sobre el cambio de estado..."
          ></textarea>
          <div class="form-text">
            Este comentario será visible en el tracking del cliente
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancelar
        </button>
        <button
          type="button"
          class="btn btn-primary"
          [disabled]="!estadoSeleccionado || cambiandoEstado"
          (click)="confirmarCambioEstado()"
        >
          <span
            *ngIf="cambiandoEstado"
            class="spinner-border spinner-border-sm me-2"
          ></span>
          <i *ngIf="!cambiandoEstado" class="ph ph-check me-2"></i>
          {{ cambiandoEstado ? "Guardando..." : "Confirmar Cambio" }}
        </button>
      </div>
    </div>
  </div>
</div>
