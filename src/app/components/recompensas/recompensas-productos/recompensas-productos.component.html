<!-- Header -->
<div class="page-header mb-24">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <h1 class="page-title">
        <i class="ph ph-package me-3"></i>
        Gestión de Productos y Categorías
      </h1>
      <p class="page-subtitle text-muted">
        Configuración de puntos y recompensas por producto y categoría
      </p>
    </div>
    
    <!-- Botón de agregar -->
    <button
      *ngIf="puedeCrear"
      type="button"
      class="btn btn-primary"
      (click)="onAgregarProducto()"
    >
      <i class="ph ph-plus me-2"></i>
      Agregar Producto
    </button>
  </div>
</div>

<!-- Tabs de Navegación -->
<div class="row mb-24">
  <div class="col-12">
    <div class="card">
      <div class="card-body p-0">
        <nav class="nav nav-tabs">
          <button
            class="nav-link"
            [class.active]="activeTab === 'productos'"
            (click)="setActiveTab('productos')"
          >
            <i class="ph ph-package me-2"></i>
            Productos
          </button>
          <button
            class="nav-link"
            [class.active]="activeTab === 'categorias'"
            (click)="setActiveTab('categorias')"
          >
            <i class="ph ph-tags me-2"></i>
            Categorías
          </button>
        </nav>
      </div>
    </div>
  </div>
</div>

<!-- Contenido de Tabs -->
<div class="tab-content">
  <!-- Tab Productos -->
  <div *ngIf="activeTab === 'productos'" class="tab-pane active">
    <!-- Filtros -->
    <div class="row mb-24">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="card-title mb-0">
              <i class="ph ph-funnel me-2"></i>
              Filtros
            </h5>
          </div>
          <div class="card-body">
            <form [formGroup]="filtrosForm">
              <div class="row g-16">
                <!-- Categoría -->
                <div class="col-md-3">
                  <label class="form-label">Categoría</label>
                  <select class="form-select" formControlName="categoria_id">
                    <option value="">Todas las categorías</option>
                    <option *ngFor="let categoria of categorias" [value]="categoria.id">
                      {{ categoria.nombre }}
                    </option>
                  </select>
                </div>
                
                <!-- Producto -->
                <div class="col-md-3">
                  <label class="form-label">Producto</label>
                  <select class="form-select" formControlName="producto_id">
                    <option value="">Todos los productos</option>
                    <option *ngFor="let producto of productosDisponibles" [value]="producto.id">
                      {{ producto.nombre }}
                    </option>
                  </select>
                </div>
                
                <!-- Estado -->
                <div class="col-md-2">
                  <label class="form-label">Estado</label>
                  <select class="form-select" formControlName="activo">
                    <option value="">Todos</option>
                    <option [value]="true">Activos</option>
                    <option [value]="false">Inactivos</option>
                  </select>
                </div>
                
                <!-- Búsqueda -->
                <div class="col-md-3">
                  <label class="form-label">Búsqueda</label>
                  <input
                    type="text"
                    class="form-control"
                    formControlName="busqueda"
                    placeholder="Buscar por nombre..."
                  />
                </div>
                
                <!-- Botón limpiar -->
                <div class="col-md-1">
                  <label class="form-label">&nbsp;</label>
                  <button
                    type="button"
                    class="btn btn-outline-secondary w-100"
                    (click)="limpiarFiltros()"
                  >
                    <i class="ph ph-x"></i>
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Tabla de Productos -->
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="card-title mb-0">
              <i class="ph ph-list me-2"></i>
              Productos Configurados
            </h5>
          </div>
          <div class="card-body">
            <!-- Loading -->
            <div *ngIf="loading" class="text-center py-48">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
              </div>
              <p class="mt-16 text-muted">Cargando productos...</p>
            </div>
            
            <!-- Tabla -->
            <div *ngIf="!loading" class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Producto</th>
                    <th>Categoría</th>
                    <th>Puntos por Unidad</th>
                    <th>Puntos por Precio</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let producto of productos">
                    <td>
                      <div class="producto-info">
                        <h6 class="producto-nombre">{{ getProductoNombre(producto.producto_id) }}</h6>
                        <small class="text-muted">ID: {{ producto.producto_id }}</small>
                      </div>
                    </td>
                    <td>
                      <span class="badge bg-light text-dark">
                        {{ getCategoriaNombre(producto.categoria_id) }}
                      </span>
                    </td>
                    <td>
                      <span class="puntos-valor">{{ producto.puntos_por_unidad }}</span>
                    </td>
                    <td>
                      <span class="puntos-valor">{{ producto.puntos_por_precio | number:'1.2-2' }}</span>
                    </td>
                    <td>
                      <span [class]="'badge ' + (producto.activo ? 'bg-success' : 'bg-danger')">
                        <i [class]="'ph ' + getEstadoIcon(producto.activo) + ' me-1'"></i>
                        {{ producto.activo ? 'Activo' : 'Inactivo' }}
                      </span>
                    </td>
                    <td>
                      <div class="btn-group" role="group">
                        <button
                          *ngIf="puedeEditar"
                          type="button"
                          class="btn btn-sm btn-outline-warning"
                          (click)="onEditarProducto(producto)"
                          title="Editar"
                        >
                          <i class="ph ph-pencil"></i>
                        </button>
                        <button
                          *ngIf="puedeEliminar"
                          type="button"
                          class="btn btn-sm btn-outline-danger"
                          (click)="onEliminarProducto(producto)"
                          title="Eliminar"
                        >
                          <i class="ph ph-trash"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
              
              <!-- Estado vacío -->
              <div *ngIf="productos.length === 0" class="empty-state">
                <i class="ph ph-package text-muted"></i>
                <h5 class="text-muted">No hay productos configurados</h5>
                <p class="text-muted">Agrega productos para comenzar a configurar puntos y recompensas.</p>
                <button
                  *ngIf="puedeCrear"
                  type="button"
                  class="btn btn-primary"
                  (click)="onAgregarProducto()"
                >
                  <i class="ph ph-plus me-2"></i>
                  Agregar Primer Producto
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Paginación -->
    <div *ngIf="!loading && productos.length > 0" class="row mt-24">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
          <div class="pagination-info">
            <span class="text-muted">
              Mostrando {{ (paginacion.pagina - 1) * paginacion.por_pagina + 1 }} a 
              {{ Math.min(paginacion.pagina * paginacion.por_pagina, paginacion.total) }} de 
              {{ paginacion.total }} productos
            </span>
          </div>
          
          <div class="d-flex align-items-center gap-16">
            <div class="per-page-selector">
              <label class="form-label me-8">Por página:</label>
              <select 
                class="form-select form-select-sm" 
                [value]="paginacion.por_pagina"
                (change)="onPerPageChange($event)"
              >
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
            </div>
            
            <nav>
              <ul class="pagination pagination-sm mb-0">
                <li class="page-item" [class.disabled]="paginacion.pagina === 1">
                  <button class="page-link" (click)="onPageChange(paginacion.pagina - 1)">
                    <i class="ph ph-caret-left"></i>
                  </button>
                </li>
                
                <li *ngFor="let pagina of getPaginas()" 
                    class="page-item" 
                    [class.active]="pagina === paginacion.pagina">
                  <button class="page-link" (click)="onPageChange(pagina)">
                    {{ pagina }}
                  </button>
                </li>
                
                <li class="page-item" [class.disabled]="paginacion.pagina === paginacion.total_paginas">
                  <button class="page-link" (click)="onPageChange(paginacion.pagina + 1)">
                    <i class="ph ph-caret-right"></i>
                  </button>
                </li>
              </ul>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Tab Categorías -->
  <div *ngIf="activeTab === 'categorias'" class="tab-pane active">
    <!-- Loading -->
    <div *ngIf="loadingCategorias" class="text-center py-48">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="mt-16 text-muted">Cargando categorías...</p>
    </div>
    
    <!-- Lista de Categorías -->
    <div *ngIf="!loadingCategorias" class="categorias-content">
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="ph ph-tags me-2"></i>
                Categorías Disponibles
              </h5>
            </div>
            <div class="card-body">
              <div *ngIf="categorias.length === 0" class="empty-state">
                <i class="ph ph-tags text-muted"></i>
                <h5 class="text-muted">No hay categorías disponibles</h5>
                <p class="text-muted">Las categorías se cargan automáticamente desde el sistema de productos.</p>
              </div>
              
              <div *ngFor="let categoria of categorias" class="categoria-item">
                <div class="categoria-header">
                  <div class="categoria-info">
                    <div class="categoria-icon">
                      <i class="ph ph-tag"></i>
                    </div>
                    <div class="categoria-content">
                      <h6 class="categoria-nombre">{{ categoria.nombre }}</h6>
                      <p class="categoria-descripcion">{{ categoria.descripcion }}</p>
                    </div>
                  </div>
                  
                  <div class="categoria-actions">
                    <span class="badge bg-info">
                      {{ categoria.productos_count }} productos
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Agregar/Editar Producto -->
<div *ngIf="showAgregarModal || showEditarModal" class="modal fade show d-block" tabindex="-1" role="dialog" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="ph ph-plus me-2" *ngIf="showAgregarModal"></i>
          <i class="ph ph-pencil me-2" *ngIf="showEditarModal"></i>
          {{ showAgregarModal ? 'Agregar Producto' : 'Editar Producto' }}
        </h5>
        <button type="button" class="btn-close" (click)="onModalClosed()" [disabled]="loading"></button>
      </div>
      
      <div class="modal-body">
        <form [formGroup]="productoForm" (ngSubmit)="onSubmitProducto()">
          <div class="row">
            <!-- Categoría -->
            <div class="col-md-6">
              <label class="form-label required">Categoría</label>
              <select class="form-select" formControlName="categoria_id" (change)="onCategoriaChange()" [disabled]="loading">
                <option value="">Seleccionar categoría...</option>
                <option *ngFor="let categoria of categorias" [value]="categoria.id">
                  {{ categoria.nombre }}
                </option>
              </select>
            </div>
            
            <!-- Producto -->
            <div class="col-md-6">
              <label class="form-label required">Producto</label>
              <select class="form-select" formControlName="producto_id" [disabled]="loading">
                <option value="">Seleccionar producto...</option>
                <option *ngFor="let producto of productosDisponibles" [value]="producto.id">
                  {{ producto.nombre }} - ${{ producto.precio_venta | number:'1.2-2' }}
                </option>
              </select>
            </div>
          </div>
          
          <div class="row mt-16">
            <!-- Puntos por Unidad -->
            <div class="col-md-6">
              <label class="form-label required">Puntos por Unidad</label>
              <input
                type="number"
                class="form-control"
                formControlName="puntos_por_unidad"
                min="1"
                placeholder="10"
                [disabled]="loading"
              />
              <div class="form-text">
                <i class="ph ph-info me-1"></i>
                Puntos otorgados por cada unidad del producto
              </div>
            </div>
            
            <!-- Puntos por Precio -->
            <div class="col-md-6">
              <label class="form-label required">Puntos por Precio</label>
              <input
                type="number"
                class="form-control"
                formControlName="puntos_por_precio"
                min="0.01"
                step="0.01"
                placeholder="0.05"
                [disabled]="loading"
              />
              <div class="form-text">
                <i class="ph ph-info me-1"></i>
                Puntos otorgados por cada peso del precio
              </div>
            </div>
          </div>
          
          <div class="row mt-16">
            <!-- Estado -->
            <div class="col-md-12">
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  formControlName="activo"
                  id="activo"
                  [disabled]="loading"
                />
                <label class="form-check-label" for="activo">
                  Producto activo
                </label>
              </div>
            </div>
          </div>
        </form>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="onModalClosed()" [disabled]="loading">
          Cancelar
        </button>
        <button
          type="button"
          class="btn btn-primary"
          (click)="onSubmitProducto()"
          [disabled]="loading || productoForm.invalid"
        >
          <span *ngIf="loading" class="spinner-border spinner-border-sm me-2" role="status"></span>
          {{ loading ? 'Guardando...' : (showAgregarModal ? 'Agregar Producto' : 'Guardar Cambios') }}
        </button>
      </div>
    </div>
  </div>
</div>
