<!-- Header -->
<div class="page-header mb-24">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <h1 class="page-title">
        <i class="ph ph-chart-line me-3"></i>
        Analytics Avanzados de Recompensas
      </h1>
      <p class="page-subtitle text-muted">
        Análisis detallado del rendimiento y tendencias del sistema de recompensas
      </p>
    </div>
    
    <!-- Botón de actualización -->
    <button
      type="button"
      class="btn btn-outline-primary"
      (click)="onFiltrosChange()"
      [disabled]="loading"
    >
      <i *ngIf="!loading" class="ph ph-arrow-clockwise me-2"></i>
      <span *ngIf="loading" class="spinner-border spinner-border-sm me-2" role="status"></span>
      {{ loading ? 'Actualizando...' : 'Actualizar' }}
    </button>
  </div>
</div>

<!-- Filtros -->
<div class="row mb-24">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="ph ph-funnel me-2"></i>
          Filtros de Análisis
        </h5>
      </div>
      <div class="card-body">
        <form [formGroup]="filtrosForm" (ngModelChange)="onFiltrosChange()">
          <div class="row g-16">
            <!-- Fecha Inicio -->
            <div class="col-md-3">
              <label class="form-label">Fecha Inicio</label>
              <input
                type="date"
                class="form-control"
                formControlName="fecha_inicio"
                [disabled]="loading"
              />
            </div>
            
            <!-- Fecha Fin -->
            <div class="col-md-3">
              <label class="form-label">Fecha Fin</label>
              <input
                type="date"
                class="form-control"
                formControlName="fecha_fin"
                [disabled]="loading"
              />
            </div>
            
            <!-- Tipo de Recompensa -->
            <div class="col-md-3">
              <label class="form-label">Tipo de Recompensa</label>
              <select class="form-select" formControlName="tipo_recompensa" [disabled]="loading">
                <option value="">Todos los tipos</option>
                <option value="puntos">Puntos</option>
                <option value="descuento">Descuentos</option>
                <option value="envio_gratis">Envío Gratuito</option>
                <option value="regalo">Regalos</option>
              </select>
            </div>
            
            <!-- Segmento de Cliente -->
            <div class="col-md-3">
              <label class="form-label">Segmento de Cliente</label>
              <select class="form-select" formControlName="segmento_cliente" [disabled]="loading">
                <option value="">Todos los segmentos</option>
                <option value="nuevos">Nuevos</option>
                <option value="regulares">Regulares</option>
                <option value="vip">VIP</option>
                <option value="inactivos">Inactivos</option>
              </select>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Tabs de Navegación -->
<div class="row mb-24">
  <div class="col-12">
    <div class="card">
      <div class="card-body p-0">
        <nav class="nav nav-tabs">
          <button
            class="nav-link"
            [class.active]="activeTab === 'dashboard'"
            (click)="setActiveTab('dashboard')"
            [disabled]="loading"
          >
            <i class="ph ph-chart-bar me-2"></i>
            Dashboard
          </button>
          <button
            class="nav-link"
            [class.active]="activeTab === 'tendencias'"
            (click)="setActiveTab('tendencias')"
            [disabled]="loading"
          >
            <i class="ph ph-trend-up me-2"></i>
            Tendencias
          </button>
          <button
            class="nav-link"
            [class.active]="activeTab === 'segmentacion'"
            (click)="setActiveTab('segmentacion')"
            [disabled]="loading"
          >
            <i class="ph ph-users-three me-2"></i>
            Segmentación
          </button>
          <button
            class="nav-link"
            [class.active]="activeTab === 'clientes'"
            (click)="setActiveTab('clientes')"
            [disabled]="loading"
          >
            <i class="ph ph-user me-2"></i>
            Clientes
          </button>
        </nav>
      </div>
    </div>
  </div>
</div>

<!-- Contenido de Tabs -->
<div class="tab-content">
  <!-- Tab Dashboard -->
  <div *ngIf="activeTab === 'dashboard'" class="tab-pane active">
    <!-- Loading -->
    <div *ngIf="loading" class="text-center py-48">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="mt-16 text-muted">Cargando datos del dashboard...</p>
    </div>
    
    <!-- Dashboard Content -->
    <div *ngIf="!loading && dashboardData" class="dashboard-content">
      <!-- Resumen Ejecutivo -->
      <div class="row mb-24">
        <div class="col-12">
          <h5 class="section-title mb-16">
            <i class="ph ph-chart-line me-2"></i>
            Resumen Ejecutivo
          </h5>
        </div>
        
        <!-- Aplicaciones del Mes -->
        <div class="col-md-4 mb-16">
          <div class="stat-card">
            <div class="stat-icon bg-primary">
              <i class="ph ph-chart-line"></i>
            </div>
            <div class="stat-content">
              <h3 class="stat-number">{{ dashboardData.resumen_ejecutivo.aplicaciones_mes | number }}</h3>
              <p class="stat-label">Aplicaciones del Mes</p>
              <div class="stat-trend">
                <i [class]="'ph ' + getTendenciaIcon(dashboardData.resumen_ejecutivo.crecimiento.aplicaciones.direccion) + ' me-1'"></i>
                <span [class]="getTendenciaClass(dashboardData.resumen_ejecutivo.crecimiento.aplicaciones.direccion)">
                  {{ dashboardData.resumen_ejecutivo.crecimiento.aplicaciones.porcentaje | number:'1.1-1' }}%
                </span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Clientes Activos -->
        <div class="col-md-4 mb-16">
          <div class="stat-card">
            <div class="stat-icon bg-success">
              <i class="ph ph-users"></i>
            </div>
            <div class="stat-content">
              <h3 class="stat-number">{{ dashboardData.resumen_ejecutivo.clientes_activos_mes | number }}</h3>
              <p class="stat-label">Clientes Activos</p>
              <div class="stat-trend">
                <i [class]="'ph ' + getTendenciaIcon(dashboardData.resumen_ejecutivo.crecimiento.clientes.direccion) + ' me-1'"></i>
                <span [class]="getTendenciaClass(dashboardData.resumen_ejecutivo.crecimiento.clientes.direccion)">
                  {{ dashboardData.resumen_ejecutivo.crecimiento.clientes.porcentaje | number:'1.1-1' }}%
                </span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Puntos Otorgados -->
        <div class="col-md-4 mb-16">
          <div class="stat-card">
            <div class="stat-icon bg-warning">
              <i class="ph ph-coins"></i>
            </div>
            <div class="stat-content">
              <h3 class="stat-number">{{ dashboardData.resumen_ejecutivo.puntos_otorgados_mes | number }}</h3>
              <p class="stat-label">Puntos Otorgados</p>
              <div class="stat-trend">
                <i [class]="'ph ' + getTendenciaIcon(dashboardData.resumen_ejecutivo.crecimiento.puntos.direccion) + ' me-1'"></i>
                <span [class]="getTendenciaClass(dashboardData.resumen_ejecutivo.crecimiento.puntos.direccion)">
                  {{ dashboardData.resumen_ejecutivo.crecimiento.puntos.porcentaje | number:'1.1-1' }}%
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Top Recompensas -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="ph ph-trophy me-2"></i>
                Top Recompensas del Mes
              </h5>
            </div>
            <div class="card-body">
              <div *ngIf="dashboardData.top_recompensas.length === 0" class="empty-state">
                <i class="ph ph-chart-line text-muted"></i>
                <p class="text-muted">No hay datos de recompensas disponibles</p>
              </div>
              
              <div *ngFor="let recompensa of dashboardData.top_recompensas" class="recompensa-item">
                <div class="recompensa-header">
                  <div class="recompensa-info">
                    <h6 class="recompensa-nombre">{{ recompensa.nombre }}</h6>
                    <span class="badge bg-light text-dark">{{ recompensa.tipo }}</span>
                  </div>
                  <div class="recompensa-metricas">
                    <div class="metrica">
                      <span class="metrica-valor">{{ recompensa.aplicaciones | number }}</span>
                      <span class="metrica-label">Aplicaciones</span>
                    </div>
                    <div class="metrica">
                      <span class="metrica-valor">{{ recompensa.clientes_unicos | number }}</span>
                      <span class="metrica-label">Clientes</span>
                    </div>
                    <div class="metrica">
                      <span class="metrica-valor">{{ recompensa.efectividad | number:'1.1-1' }}%</span>
                      <span class="metrica-label">Efectividad</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Tab Tendencias -->
  <div *ngIf="activeTab === 'tendencias'" class="tab-pane active">
    <div *ngIf="loading" class="text-center py-48">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="mt-16 text-muted">Analizando tendencias...</p>
    </div>
    
    <div *ngIf="!loading && tendenciasData" class="tendencias-content">
      <!-- Comparativa de Períodos -->
      <div class="row mb-24">
        <div class="col-12">
          <h5 class="section-title mb-16">
            <i class="ph ph-trend-up me-2"></i>
            Comparativa de Períodos
          </h5>
        </div>
        
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h6 class="card-title mb-0">Período Actual</h6>
            </div>
            <div class="card-body">
              <div class="metricas-grid">
                <div class="metrica-item">
                  <span class="metrica-valor">{{ tendenciasData.comparativa_periodos.periodo_actual.aplicaciones | number }}</span>
                  <span class="metrica-label">Aplicaciones</span>
                </div>
                <div class="metrica-item">
                  <span class="metrica-valor">{{ tendenciasData.comparativa_periodos.periodo_actual.clientes_unicos | number }}</span>
                  <span class="metrica-label">Clientes Únicos</span>
                </div>
                <div class="metrica-item">
                  <span class="metrica-valor">{{ tendenciasData.comparativa_periodos.periodo_actual.puntos_otorgados | number }}</span>
                  <span class="metrica-label">Puntos Otorgados</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h6 class="card-title mb-0">Período Anterior</h6>
            </div>
            <div class="card-body">
              <div class="metricas-grid">
                <div class="metrica-item">
                  <span class="metrica-valor">{{ tendenciasData.comparativa_periodos.periodo_anterior.aplicaciones | number }}</span>
                  <span class="metrica-label">Aplicaciones</span>
                </div>
                <div class="metrica-item">
                  <span class="metrica-valor">{{ tendenciasData.comparativa_periodos.periodo_anterior.clientes_unicos | number }}</span>
                  <span class="metrica-label">Clientes Únicos</span>
                </div>
                <div class="metrica-item">
                  <span class="metrica-valor">{{ tendenciasData.comparativa_periodos.periodo_anterior.puntos_otorgados | number }}</span>
                  <span class="metrica-label">Puntos Otorgados</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Patrones Identificados -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="ph ph-lightbulb me-2"></i>
                Patrones Identificados
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-3">
                  <div class="patron-item">
                    <i class="ph ph-calendar text-primary"></i>
                    <h6>Día Más Activo</h6>
                    <p>{{ tendenciasData.patrones_identificados.dia_semana_mas_activo }}</p>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="patron-item">
                    <i class="ph ph-clock text-success"></i>
                    <h6>Hora Pico</h6>
                    <p>{{ tendenciasData.patrones_identificados.hora_pico }}</p>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="patron-item">
                    <i class="ph ph-trend-up text-warning"></i>
                    <h6>Tendencia</h6>
                    <p class="text-capitalize">{{ tendenciasData.patrones_identificados.tendencia_crecimiento }}</p>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="patron-item">
                    <i class="ph ph-star text-info"></i>
                    <h6>Estacionalidad</h6>
                    <p>{{ tendenciasData.patrones_identificados.estacionalidad.join(', ') }}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Tab Segmentación -->
  <div *ngIf="activeTab === 'segmentacion'" class="tab-pane active">
    <div *ngIf="loading" class="text-center py-48">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="mt-16 text-muted">Analizando segmentación...</p>
    </div>
    
    <div *ngIf="!loading && segmentacionData" class="segmentacion-content">
      <!-- Resumen General -->
      <div class="row mb-24">
        <div class="col-12">
          <h5 class="section-title mb-16">
            <i class="ph ph-users-three me-2"></i>
            Resumen de Segmentación
          </h5>
        </div>
        
        <div class="col-md-3">
          <div class="stat-card">
            <div class="stat-icon bg-primary">
              <i class="ph ph-users-three"></i>
            </div>
            <div class="stat-content">
              <h3 class="stat-number">{{ segmentacionData.resumen_general.total_segmentos }}</h3>
              <p class="stat-label">Total Segmentos</p>
            </div>
          </div>
        </div>
        
        <div class="col-md-3">
          <div class="stat-card">
            <div class="stat-icon bg-success">
              <i class="ph ph-check-circle"></i>
            </div>
            <div class="stat-content">
              <h3 class="stat-number">{{ segmentacionData.resumen_general.segmentos_activos }}</h3>
              <p class="stat-label">Segmentos Activos</p>
            </div>
          </div>
        </div>
        
        <div class="col-md-3">
          <div class="stat-card">
            <div class="stat-icon bg-info">
              <i class="ph ph-users"></i>
            </div>
            <div class="stat-content">
              <h3 class="stat-number">{{ segmentacionData.resumen_general.clientes_activos | number }}</h3>
              <p class="stat-label">Clientes Activos</p>
            </div>
          </div>
        </div>
        
        <div class="col-md-3">
          <div class="stat-card">
            <div class="stat-icon bg-warning">
              <i class="ph ph-chart-line"></i>
            </div>
            <div class="stat-content">
              <h3 class="stat-number">{{ segmentacionData.resumen_general.aplicaciones_totales | number }}</h3>
              <p class="stat-label">Aplicaciones Totales</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Análisis por Segmento -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="ph ph-chart-bar me-2"></i>
                Análisis por Segmento
              </h5>
            </div>
            <div class="card-body">
              <div *ngIf="segmentacionData.por_segmento.length === 0" class="empty-state">
                <i class="ph ph-users-three text-muted"></i>
                <p class="text-muted">No hay datos de segmentación disponibles</p>
              </div>
              
              <div *ngFor="let segmento of segmentacionData.por_segmento" class="segmento-item">
                <div class="segmento-header">
                  <div class="segmento-info">
                    <h6 class="segmento-nombre">{{ segmento.segmento_nombre }}</h6>
                    <span class="badge bg-light text-dark">{{ segmento.segmento }}</span>
                  </div>
                  <div class="segmento-metricas">
                    <div class="metrica">
                      <span class="metrica-valor">{{ segmento.clientes_activos | number }}</span>
                      <span class="metrica-label">Activos</span>
                    </div>
                    <div class="metrica">
                      <span class="metrica-valor">{{ segmento.aplicaciones_totales | number }}</span>
                      <span class="metrica-label">Aplicaciones</span>
                    </div>
                    <div class="metrica">
                      <span class="metrica-valor">{{ segmento.efectividad | number:'1.1-1' }}%</span>
                      <span class="metrica-label">Efectividad</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Tab Clientes -->
  <div *ngIf="activeTab === 'clientes'" class="tab-pane active">
    <div *ngIf="loading" class="text-center py-48">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="mt-16 text-muted">Analizando comportamiento de clientes...</p>
    </div>
    
    <div *ngIf="!loading && clientesData" class="clientes-content">
      <!-- Resumen de Clientes -->
      <div class="row mb-24">
        <div class="col-12">
          <h5 class="section-title mb-16">
            <i class="ph ph-user me-2"></i>
            Resumen de Clientes
          </h5>
        </div>
        
        <div class="col-md-3">
          <div class="stat-card">
            <div class="stat-icon bg-primary">
              <i class="ph ph-users"></i>
            </div>
            <div class="stat-content">
              <h3 class="stat-number">{{ clientesData.resumen.total_clientes | number }}</h3>
              <p class="stat-label">Total Clientes</p>
            </div>
          </div>
        </div>
        
        <div class="col-md-3">
          <div class="stat-card">
            <div class="stat-icon bg-success">
              <i class="ph ph-user-check"></i>
            </div>
            <div class="stat-content">
              <h3 class="stat-number">{{ clientesData.resumen.clientes_activos | number }}</h3>
              <p class="stat-label">Clientes Activos</p>
            </div>
          </div>
        </div>
        
        <div class="col-md-3">
          <div class="stat-card">
            <div class="stat-icon bg-info">
              <i class="ph ph-user-plus"></i>
            </div>
            <div class="stat-content">
              <h3 class="stat-number">{{ clientesData.resumen.clientes_nuevos_mes | number }}</h3>
              <p class="stat-label">Nuevos este Mes</p>
            </div>
          </div>
        </div>
        
        <div class="col-md-3">
          <div class="stat-card">
            <div class="stat-icon bg-warning">
              <i class="ph ph-user-circle-plus"></i>
            </div>
            <div class="stat-content">
              <h3 class="stat-number">{{ clientesData.resumen.clientes_reactivados | number }}</h3>
              <p class="stat-label">Reactivados</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Segmentación por Comportamiento -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="ph ph-chart-pie me-2"></i>
                Segmentación por Comportamiento
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-4">
                  <div class="comportamiento-item">
                    <div class="comportamiento-icon bg-success">
                      <i class="ph ph-users"></i>
                    </div>
                    <div class="comportamiento-content">
                      <h6>Clientes Frecuentes</h6>
                      <span class="comportamiento-numero">{{ clientesData.segmentacion_comportamiento.clientes_frecuentes | number }}</span>
                    </div>
                  </div>
                </div>
                
                <div class="col-md-4">
                  <div class="comportamiento-item">
                    <div class="comportamiento-icon bg-info">
                      <i class="ph ph-user"></i>
                    </div>
                    <div class="comportamiento-content">
                      <h6>Clientes Ocasionales</h6>
                      <span class="comportamiento-numero">{{ clientesData.segmentacion_comportamiento.clientes_ocasionales | number }}</span>
                    </div>
                  </div>
                </div>
                
                <div class="col-md-4">
                  <div class="comportamiento-item">
                    <div class="comportamiento-icon bg-warning">
                      <i class="ph ph-user-minus"></i>
                    </div>
                    <div class="comportamiento-content">
                      <h6>Clientes Inactivos</h6>
                      <span class="comportamiento-numero">{{ clientesData.segmentacion_comportamiento.clientes_inactivos | number }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
