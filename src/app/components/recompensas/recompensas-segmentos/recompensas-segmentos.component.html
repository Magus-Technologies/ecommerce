<!-- Header -->
<div class="page-header mb-24">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <h1 class="page-title">
        <i class="ph ph-users-three me-3"></i>
        Segmentación de Clientes
      </h1>
      <p class="page-subtitle text-muted">
        Configuración y gestión de segmentos de clientes para recompensas
      </p>
    </div>
    
    <!-- Botones de acción -->
    <div class="d-flex gap-12">
      <button
        *ngIf="puedeCrear"
        type="button"
        class="btn btn-outline-primary"
        (click)="onValidarCliente()"
      >
        <i class="ph ph-magnifying-glass me-2"></i>
        Validar Cliente
      </button>
      <button
        *ngIf="puedeCrear"
        type="button"
        class="btn btn-primary"
        (click)="onAgregarSegmento()"
      >
        <i class="ph ph-plus me-2"></i>
        Agregar Segmento
      </button>
    </div>
  </div>
</div>

<!-- Tabs de Navegación -->
<div class="row mb-24">
  <div class="col-12">
    <div class="card">
      <div class="card-body p-0">
        <nav class="nav nav-tabs">
          <button
            class="nav-link"
            [class.active]="activeTab === 'segmentos'"
            (click)="setActiveTab('segmentos')"
          >
            <i class="ph ph-list me-2"></i>
            Segmentos Configurados
          </button>
          <button
            class="nav-link"
            [class.active]="activeTab === 'estadisticas'"
            (click)="setActiveTab('estadisticas')"
          >
            <i class="ph ph-chart-bar me-2"></i>
            Estadísticas
          </button>
        </nav>
      </div>
    </div>
  </div>
</div>

<!-- Contenido de Tabs -->
<div class="tab-content">
  <!-- Tab Segmentos -->
  <div *ngIf="activeTab === 'segmentos'" class="tab-pane active">
    <!-- Loading -->
    <div *ngIf="loading" class="text-center py-48">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="mt-16 text-muted">Cargando segmentos...</p>
    </div>
    
    <!-- Lista de Segmentos -->
    <div *ngIf="!loading" class="segmentos-content">
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="ph ph-list me-2"></i>
                Segmentos Configurados
              </h5>
            </div>
            <div class="card-body">
              <div *ngIf="segmentosAsignados.length === 0" class="empty-state">
                <i class="ph ph-users-three text-muted"></i>
                <h5 class="text-muted">No hay segmentos configurados</h5>
                <p class="text-muted">Agrega segmentos para comenzar a configurar recompensas por tipo de cliente.</p>
                <button
                  *ngIf="puedeCrear"
                  type="button"
                  class="btn btn-primary"
                  (click)="onAgregarSegmento()"
                >
                  <i class="ph ph-plus me-2"></i>
                  Agregar Primer Segmento
                </button>
              </div>
              
              <div *ngFor="let segmento of segmentosAsignados" class="segmento-item">
                <div class="segmento-header">
                  <div class="segmento-info">
                    <div class="segmento-icon">
                      <i [class]="'ph ' + getSegmentoIcon(segmento.segmento)"></i>
                    </div>
                    <div class="segmento-content">
                      <h6 class="segmento-nombre">{{ segmento.segmento_nombre }}</h6>
                      <p class="segmento-tipo">
                        {{ segmento.es_cliente_especifico ? 'Cliente específico' : 'Segmento general' }}
                      </p>
                    </div>
                  </div>
                  
                  <div class="segmento-actions">
                    <span [class]="'badge ' + getSegmentoColor(segmento.segmento)">
                      {{ segmento.segmento }}
                    </span>
                    
                    <div class="btn-group" role="group">
                      <button
                        *ngIf="puedeEditar"
                        type="button"
                        class="btn btn-sm btn-outline-warning"
                        title="Editar"
                      >
                        <i class="ph ph-pencil"></i>
                      </button>
                      <button
                        *ngIf="puedeEliminar"
                        type="button"
                        class="btn btn-sm btn-outline-danger"
                        (click)="onEliminarSegmento(segmento)"
                        title="Eliminar"
                      >
                        <i class="ph ph-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Tab Estadísticas -->
  <div *ngIf="activeTab === 'estadisticas'" class="tab-pane active">
    <!-- Loading -->
    <div *ngIf="loadingEstadisticas" class="text-center py-48">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p class="mt-16 text-muted">Cargando estadísticas...</p>
    </div>
    
    <!-- Estadísticas -->
    <div *ngIf="!loadingEstadisticas && estadisticas" class="estadisticas-content">
      <!-- Resumen General -->
      <div class="row mb-24">
        <div class="col-12">
          <h5 class="section-title mb-16">
            <i class="ph ph-chart-bar me-2"></i>
            Resumen de Segmentación
          </h5>
        </div>
        
        <div class="col-md-3">
          <div class="stat-card">
            <div class="stat-icon bg-primary">
              <i class="ph ph-users-three"></i>
            </div>
            <div class="stat-content">
              <h3 class="stat-number">{{ estadisticas.total_segmentos_configurados }}</h3>
              <p class="stat-label">Segmentos Configurados</p>
            </div>
          </div>
        </div>
        
        <div class="col-md-3">
          <div class="stat-card">
            <div class="stat-icon bg-success">
              <i class="ph ph-user"></i>
            </div>
            <div class="stat-content">
              <h3 class="stat-number">{{ estadisticas.clientes_especificos }}</h3>
              <p class="stat-label">Clientes Específicos</p>
            </div>
          </div>
        </div>
        
        <div class="col-md-3">
          <div class="stat-card">
            <div class="stat-icon bg-info">
              <i class="ph ph-list"></i>
            </div>
            <div class="stat-content">
              <h3 class="stat-number">{{ estadisticas.segmentos_generales }}</h3>
              <p class="stat-label">Segmentos Generales</p>
            </div>
          </div>
        </div>
        
        <div class="col-md-3">
          <div class="stat-card">
            <div class="stat-icon bg-warning">
              <i class="ph ph-users"></i>
            </div>
            <div class="stat-content">
              <h3 class="stat-number">{{ estadisticas.clientes_potenciales.todos | number }}</h3>
              <p class="stat-label">Total Clientes</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Distribución de Clientes -->
      <div class="row mb-24">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="ph ph-chart-pie me-2"></i>
                Distribución de Clientes por Segmento
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-3">
                  <div class="distribucion-item">
                    <div class="distribucion-icon bg-info">
                      <i class="ph ph-user-plus"></i>
                    </div>
                    <div class="distribucion-content">
                      <h6>Clientes Nuevos</h6>
                      <span class="distribucion-numero">{{ estadisticas.clientes_potenciales.nuevos | number }}</span>
                      <span class="distribucion-porcentaje">{{ estadisticas.clientes_potenciales.distribuciones.nuevos_porcentaje | number:'1.1-1' }}%</span>
                    </div>
                  </div>
                </div>
                
                <div class="col-md-3">
                  <div class="distribucion-item">
                    <div class="distribucion-icon bg-primary">
                      <i class="ph ph-user"></i>
                    </div>
                    <div class="distribucion-content">
                      <h6>Clientes Regulares</h6>
                      <span class="distribucion-numero">{{ estadisticas.clientes_potenciales.regulares | number }}</span>
                      <span class="distribucion-porcentaje">{{ estadisticas.clientes_potenciales.distribuciones.regulares_porcentaje | number:'1.1-1' }}%</span>
                    </div>
                  </div>
                </div>
                
                <div class="col-md-3">
                  <div class="distribucion-item">
                    <div class="distribucion-icon bg-warning">
                      <i class="ph ph-crown"></i>
                    </div>
                    <div class="distribucion-content">
                      <h6>Clientes VIP</h6>
                      <span class="distribucion-numero">{{ estadisticas.clientes_potenciales.vip | number }}</span>
                      <span class="distribucion-porcentaje">{{ estadisticas.clientes_potenciales.distribuciones.vip_porcentaje | number:'1.1-1' }}%</span>
                    </div>
                  </div>
                </div>
                
                <div class="col-md-3">
                  <div class="distribucion-item">
                    <div class="distribucion-icon bg-secondary">
                      <i class="ph ph-user-minus"></i>
                    </div>
                    <div class="distribucion-content">
                      <h6>Clientes Inactivos</h6>
                      <span class="distribucion-numero">{{ estadisticas.clientes_potenciales.inactivos | number }}</span>
                      <span class="distribucion-porcentaje">{{ estadisticas.clientes_potenciales.distribuciones.inactivos_porcentaje | number:'1.1-1' }}%</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Efectividad por Segmento -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="ph ph-trophy me-2"></i>
                Efectividad por Segmento
              </h5>
            </div>
            <div class="card-body">
              <div *ngIf="estadisticas.efectividad_segmentos.length === 0" class="empty-state">
                <i class="ph ph-chart-line text-muted"></i>
                <p class="text-muted">No hay datos de efectividad disponibles</p>
              </div>
              
              <div *ngFor="let efectividad of estadisticas.efectividad_segmentos" class="efectividad-item">
                <div class="efectividad-header">
                  <div class="efectividad-info">
                    <h6 class="efectividad-nombre">{{ efectividad.segmento_nombre }}</h6>
                    <span class="badge bg-light text-dark">{{ efectividad.segmento }}</span>
                  </div>
                  <div class="efectividad-metricas">
                    <div class="metrica">
                      <span class="metrica-valor">{{ efectividad.metricas.aplicaciones_totales | number }}</span>
                      <span class="metrica-label">Aplicaciones</span>
                    </div>
                    <div class="metrica">
                      <span class="metrica-valor">{{ efectividad.metricas.clientes_unicos | number }}</span>
                      <span class="metrica-label">Clientes Únicos</span>
                    </div>
                    <div class="metrica">
                      <span class="metrica-valor">{{ efectividad.metricas.promedio_aplicaciones_por_cliente | number:'1.1-1' }}</span>
                      <span class="metrica-label">Promedio/Cliente</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Agregar Segmento -->
<div *ngIf="showAgregarModal" class="modal fade show d-block" tabindex="-1" role="dialog" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="ph ph-plus me-2"></i>
          Agregar Segmento
        </h5>
        <button type="button" class="btn-close" (click)="onModalClosed()" [disabled]="loading"></button>
      </div>
      
      <div class="modal-body">
        <form [formGroup]="segmentoForm" (ngSubmit)="onSubmitSegmento()">
          <div class="mb-16">
            <label class="form-label required">Tipo de Segmento</label>
            <select class="form-select" formControlName="segmento" [disabled]="loading">
              <option value="">Seleccionar segmento...</option>
              <option *ngFor="let segmento of segmentosDisponibles" [value]="segmento.value">
                {{ segmento.label }}
              </option>
            </select>
            <div class="form-text">
              <i class="ph ph-info me-1"></i>
              <span *ngIf="segmentoForm.get('segmento')?.value">
                {{ getSegmentoDescription(segmentoForm.get('segmento')?.value) }}
              </span>
            </div>
          </div>
          
          <div class="mb-16">
            <label class="form-label">Cliente Específico (Opcional)</label>
            <input
              type="text"
              class="form-control"
              formControlName="cliente_id"
              placeholder="ID del cliente específico"
              [disabled]="loading"
            />
            <div class="form-text">
              <i class="ph ph-info me-1"></i>
              Deja vacío para aplicar a todo el segmento
            </div>
          </div>
        </form>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="onModalClosed()" [disabled]="loading">
          Cancelar
        </button>
        <button
          type="button"
          class="btn btn-primary"
          (click)="onSubmitSegmento()"
          [disabled]="loading || segmentoForm.invalid"
        >
          <span *ngIf="loading" class="spinner-border spinner-border-sm me-2" role="status"></span>
          {{ loading ? 'Agregando...' : 'Agregar Segmento' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Validación de Cliente -->
<div *ngIf="showValidacionModal" class="modal fade show d-block" tabindex="-1" role="dialog" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="ph ph-magnifying-glass me-2"></i>
          Validar Cliente
        </h5>
        <button type="button" class="btn-close" (click)="onModalClosed()" [disabled]="loading"></button>
      </div>
      
      <div class="modal-body">
        <form [formGroup]="validacionForm" (ngSubmit)="onSubmitValidacion()">
          <div class="row">
            <div class="col-md-6">
              <label class="form-label required">Email del Cliente</label>
              <input
                type="email"
                class="form-control"
                formControlName="email"
                placeholder="cliente@ejemplo.com"
                [disabled]="loading"
              />
            </div>
            <div class="col-md-6">
              <label class="form-label">Número de Documento</label>
              <input
                type="text"
                class="form-control"
                formControlName="numero_documento"
                placeholder="12345678"
                [disabled]="loading"
              />
            </div>
          </div>
        </form>
        
        <!-- Resultado de Validación -->
        <div *ngIf="validacionResultado" class="mt-24">
          <div class="card">
            <div class="card-header">
              <h6 class="card-title mb-0">Resultado de Validación</h6>
            </div>
            <div class="card-body">
              <div class="validacion-resultado">
                <div class="cliente-info">
                  <h6>{{ validacionResultado.cliente.nombre_completo }}</h6>
                  <p class="text-muted">{{ validacionResultado.cliente.email }}</p>
                </div>
                
                <div class="validacion-status">
                  <span [class]="'badge ' + (validacionResultado.cumple_recompensa ? 'bg-success' : 'bg-danger')">
                    {{ validacionResultado.cumple_recompensa ? 'Cumple Recompensa' : 'No Cumple' }}
                  </span>
                </div>
                
                <div class="segmentos-cumplidos">
                  <h6>Segmentos Cumplidos:</h6>
                  <div class="segmentos-list">
                    <span *ngFor="let segmento of validacionResultado.segmentos_cumplidos" 
                          class="badge bg-light text-dark me-2">
                      {{ segmento.segmento_nombre }}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="onModalClosed()" [disabled]="loading">
          Cerrar
        </button>
        <button
          type="button"
          class="btn btn-primary"
          (click)="onSubmitValidacion()"
          [disabled]="loading || validacionForm.invalid"
        >
          <span *ngIf="loading" class="spinner-border spinner-border-sm me-2" role="status"></span>
          {{ loading ? 'Validando...' : 'Validar Cliente' }}
        </button>
      </div>
    </div>
  </div>
</div>
