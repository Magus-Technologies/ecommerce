<!-- ========================= Arma PC Section Start =============================== -->
<section class="py-40">
  <div class="container container-lg">
    <!-- ✅ NUEVA SECCIÓN: Header con título y progreso -->
    <div class="row mb-32">
      <div class="col-12">
        <div class="text-center mb-32">
          <h5 class="text-heading fw-semibold mb-24" style="font-size: 1.25rem;">Arma tu PC paso a paso</h5>
        </div>

        <!-- ✅ NUEVO: Tracking horizontal de pasos (como en las imágenes) -->
        <div class="steps-tracker bg-white border border-gray-100 rounded-12 p-24 mb-32 shadow-sm">
          <div class="d-flex justify-content-between align-items-center position-relative">
            <!-- Línea conectora de fondo -->
            <div
              class="steps-line position-absolute h-2 bg-gray-200 top-50 translate-middle-y"
              style="z-index: 1; left: 20px; right: 20px; width: calc(100% - 40px);">
            </div>
            <div
              class="steps-line-active position-absolute h-2 bg-main-600 top-50 translate-middle-y transition-all duration-500"
              style="z-index: 2; left: 20px;"
              [style.width]="pasos.length > 0 ? 'calc(' + (((pasoActual + 1) / pasos.length) * 100) + '% - 40px)' : '0'"
            ></div>

            <!-- Pasos individuales -->
            <div 
              *ngFor="let paso of pasos; let i = index"
              class="step-item text-center position-relative"
              style="z-index: 3;"
              [class.completed]="paso.completado"
              [class.active]="i === pasoActual"
              [class.disabled]="!puedeAccederAPaso(i)"
            >
              <!-- Círculo del paso -->
              <div 
                class="step-circle d-inline-flex align-items-center justify-content-center rounded-circle fw-semibold text-sm cursor-pointer transition-all"
                style="width: 40px; height: 40px;"
                [ngClass]="{
                  'bg-main-600 text-white': paso.completado,
                  'bg-main-600 text-white border-3 border-main-200': i === pasoActual,
                  'bg-gray-200 text-gray-600': !paso.completado && i !== pasoActual,
                  'hover-bg-main-100': puedeAccederAPaso(i)
                }"
                (click)="puedeAccederAPaso(i) ? irAPaso(i) : null"
                [title]="paso.descripcion_paso || paso.nombre_paso"
              >
                <!-- Ícono de completado -->
                <i *ngIf="paso.completado" class="ph ph-check text-sm"></i>
                <!-- Número del paso -->
                <span *ngIf="!paso.completado">{{ i + 1 }}</span>
              </div>

              <!-- Información del paso -->
              <div class="step-info mt-12">
                <div class="step-title text-sm fw-semibold text-heading">{{ paso.nombre_paso }}</div>
                <div class="step-subtitle text-xs text-gray-500 mt-4">
                  {{ paso.productos_count }} productos
                  <span *ngIf="paso.es_requerido" class="text-danger">*</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <!-- ✅ MODIFICADO: Sidebar más compacto -->
      <div class="col-lg-3">
        <div class="shop-sidebar">
          <button type="button"
                  class="shop-sidebar__close d-lg-none d-flex w-32 h-32 flex-center border border-gray-100 rounded-circle hover-bg-main-600 position-absolute inset-inline-end-0 me-10 mt-8 hover-text-white hover-border-main-600">
              <i class="ph ph-x"></i>
          </button>
          
          <!-- ✅ NUEVO: Información del paso actual -->
          <div class="shop-sidebar__box border border-gray-100 rounded-8 p-24 mb-24" *ngIf="pasos.length > 0">
            <div class="d-flex align-items-center mb-16">
              <div class="step-icon bg-main-600 text-white rounded-circle me-12 flex-shrink-0" style="width: 32px; height: 32px;">
                <i class="ph ph-desktop text-sm" style="margin-left: 9px; margin-top: 9px;"></i>
              </div>
              <div>
                <h6 class="text-md fw-semibold mb-4">{{ pasos[pasoActual]?.nombre_paso }}</h6>
                <small class="text-gray-500">Paso {{ pasoActual + 1 }} de {{ pasos.length }}</small>
              </div>
            </div>
            
            <p class="text-gray-600 text-sm mb-16" *ngIf="pasos[pasoActual]?.descripcion_paso">
              {{ pasos[pasoActual].descripcion_paso }}
            </p>

            <div class="d-flex align-items-center justify-content-between text-sm">
              <span class="text-gray-500">{{ pasos[pasoActual]?.productos_count || 0 }} productos disponibles</span>
              <span *ngIf="pasos[pasoActual]?.es_requerido" class="badge bg-danger-50 text-danger-600 px-8 py-4">
                Requerido
              </span>
            </div>
          </div>
        </div>
      </div>
      <!-- Sidebar End -->

      <!-- Content Start -->
      <div class="col-lg-9">
        <!-- ✅ NUEVO: Header del paso actual -->
        <div class="d-flex justify-content-between align-items-center mb-24" *ngIf="pasos.length > 0">
          <div>
            <h5 class="text-heading fw-semibold mb-8">{{ pasos[pasoActual]?.nombre_paso }}</h5>
            <p class="text-gray-600 text-sm mb-0">{{ pasos[pasoActual]?.descripcion_paso || 'Selecciona el componente perfecto para tu configuración' }}</p>
          </div>
          
          <!-- ✅ NUEVOS: Botones de navegación mejorados -->
          <div class="d-flex gap-8">
            <!-- Botón Anterior - Solo visible si no estamos en el primer paso -->
            <button 
              type="button"
              class="btn bg-gray-400 px-16 py-8 rounded-6 fw-medium"
              (click)="pasoAnterior()"
              *ngIf="pasoActual > 0"
              title="Volver al paso anterior"
            >
              <i class="ph ph-arrow-left text-sm me-8"></i>
              Paso Anterior
            </button>
            
            <!-- Botón Siguiente - Cambia según el contexto -->
            <button 
              type="button"
              class="btn px-16 py-8 rounded-6 fw-medium"
              [ngClass]="{
                'btn-main': pasoActual < pasos.length - 1,
                'btn-success': pasoActual === pasos.length - 1 && puedeFinalizarConfiguracion(),
                'btn-outline-main': pasoActual === pasos.length - 1 && !puedeFinalizarConfiguracion()
              }"
              (click)="pasoActual < pasos.length - 1 ? siguientePaso() : null"
              [disabled]="pasoActual >= pasos.length - 1"
              [title]="pasoActual < pasos.length - 1 ? 'Avanzar al siguiente paso' : 'Último paso completado'"
            >
              <!-- Texto dinámico según el estado -->
              <span *ngIf="pasoActual < pasos.length - 1">
                Siguiente Paso
                <i class="ph ph-arrow-right text-sm ms-8"></i>
              </span>
              <span *ngIf="pasoActual === pasos.length - 1 && puedeFinalizarConfiguracion()">
                <i class="ph ph-check text-sm me-8"></i>
                Configuración Completa
              </span>
              <span *ngIf="pasoActual === pasos.length - 1 && !puedeFinalizarConfiguracion()">
                <i class="ph ph-info text-sm me-8"></i>
                Último Paso
              </span>
            </button>
          </div>
        </div>
        
        <div class="row">
          <!-- Columna de productos -->
          <div class="col-lg-8">
            <!-- Estado inicial -->
            <div *ngIf="pasos.length === 0" class="text-center py-32">
              <div class="bg-gray-50 rounded-12 py-32 px-24">
                <div class="spinner-border text-main-600 mb-16"></div>
                <h6 class="text-heading mb-8">Cargando configuración</h6>
                <p class="text-gray-500 text-sm mb-0">Preparando el sistema de armado...</p>
              </div>
            </div>

            <!-- Loading productos del paso actual -->
            <div *ngIf="productosDelPasoLoading" class="text-center py-32">
              <div class="bg-main-50 rounded-12 py-32 px-24">
                <div class="spinner-border text-main-600 mb-16" style="width: 2rem; height: 2rem;"></div>
                <h6 class="text-main-600 mb-8">Cargando productos</h6>
                <p class="text-gray-600 text-sm">Buscando componentes compatibles...</p>
              </div>
            </div>

            <!-- Lista de productos del paso actual -->
            <div *ngIf="!productosDelPasoLoading && productosDelPasoActual.length > 0">
              <!-- ✅ CORREGIDO: Grid responsivo con ancho máximo para evitar cards muy anchos -->
              <div class="row g-16">
                <div *ngFor="let producto of productosDelPasoActual" 
                     class="col-12 col-sm-6 col-md-4 col-lg-6 col-xl-4">
                  <div class="product-card h-100 p-16 border border-gray-100 hover-border-main-600 rounded-16 position-relative transition-2"
                       [ngClass]="{ 'border-main-600 bg-main-50': isProductoSeleccionado(producto) }">
                  
                  <!-- Checkbox -->
                  <div class="custom-checkbox position-absolute" style="top: 12px; left: 12px; z-index: 2;">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      [id]="'producto-' + producto.id"
                      [checked]="isProductoSeleccionado(producto)"
                      (change)="toggleProductoArmado(producto, $event)"
                    />
                  </div>

                  <!-- Imagen del producto -->
                  <div class="product-card__thumb flex-center rounded-8 bg-gray-50 position-relative" style="height: 200px;">
                    <img
                      [src]="producto.imagen_principal"
                      [alt]="producto.nombre"
                      (error)="onImageError($event)"
                      loading="lazy"
                      class="w-100 h-100 object-fit-contain"
                      style="max-width: 180px; max-height: 180px;"
                    />
                  </div>

                  <!-- Información del producto -->
                  <div class="product-card__content mt-16">
                    <h6 class="title text-lg fw-semibold mt-12 mb-8">
                      <span class="link text-line-2">{{ producto.nombre }}</span>
                    </h6>
                    
                    <p class="text-gray-500 mb-12 text-sm text-line-2">{{ producto.descripcion }}</p>
                    
                    <div class="product-card__price my-20">
                      <span *ngIf="producto.precio_oferta" 
                            class="text-gray-400 text-md fw-semibold text-decoration-line-through d-block">
                        S/ {{ getPrecioNumerico(producto.precio).toFixed(2) }}
                      </span>
                      <span class="text-heading text-md fw-semibold">
                        S/ {{ getPrecioNumerico(producto.precio_oferta || producto.precio).toFixed(2) }}
                      </span>
                    </div>
                    
                    <div class="mb-12">
                      <span class="text-gray-600 text-sm">Stock: {{ producto.stock }}</span>
                    </div>
                  </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Mensaje si no hay productos -->
            <div *ngIf="!productosDelPasoLoading && productosDelPasoActual.length === 0 && pasos.length > 0" class="text-center py-32">
              <div class="bg-warning-50 border border-warning-200 rounded-12 py-32 px-24">
                <span class="w-56 h-56 text-2xl text-warning-600 mb-16 mx-auto border border-warning-400 border-dashed rounded-circle flex-center">
                  <i class="ph ph-package"></i>
                </span>
                <h6 class="mb-8 text-warning-700 fw-semibold">Sin productos compatibles</h6>
                <p class="text-warning-600 text-sm mb-16">
                  No hay productos disponibles para el paso "{{ pasos[pasoActual]?.nombre_paso }}" con tu selección actual.
                </p>
                
                <!-- Sugerencia de acción -->
                <div class="d-flex gap-8 justify-content-center">
                  <button 
                    type="button"
                    class="btn btn-outline-warning btn-sm px-16 py-8 rounded-6"
                    (click)="pasoAnterior()"
                    *ngIf="pasoActual > 0"
                  >
                    <i class="ph ph-arrow-left me-4"></i>
                    Cambiar selección anterior
                  </button>
                  <button 
                    type="button"
                    class="btn btn-warning btn-sm px-16 py-8 rounded-6"
                    (click)="siguientePaso()"
                    *ngIf="!pasos[pasoActual]?.es_requerido && pasoActual < pasos.length - 1"
                  >
                    Saltar paso
                    <i class="ph ph-arrow-right ms-4"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Columna de resumen -->
          <div class="col-lg-4">
            <div class="shop-sidebar__box border border-gray-100 rounded-8 p-24 mb-24 sticky-top" style="top: 20px;">
              <div class="d-flex align-items-center justify-content-between mb-20">
                <h6 class="text-lg fw-semibold mb-0">
                  <i class="ph ph-cpu me-8 text-main-600"></i>
                  Mi Configuración
                </h6>
                <div class="badge bg-main-50 text-main-600 px-8 py-4 text-xs">
                  {{ getProgresoConfiguracion().completados }}/{{ getProgresoConfiguracion().total }}
                </div>
              </div>
              
              <!-- Mini progreso -->
              <div class="progress-mini bg-gray-100 rounded-pill mb-20" style="height: 6px;">
                <div 
                  class="progress-bar-mini bg-main-600 rounded-pill h-100 transition-all duration-300"
                  [style.width.%]="getProgresoConfiguracion().porcentaje"
                ></div>
              </div>

              <!-- Estado vacío -->
              <div *ngIf="productosSeleccionados.length === 0" class="text-center py-20">
                <span class="w-48 h-48 text-xl text-gray-300 mb-8 mx-auto border border-gray-200 border-dashed rounded-circle flex-center">
                  <i class="ph ph-cpu"></i>
                </span>
                <p class="text-gray-500 mb-2 text-xs">No hay componentes seleccionados</p>
                <small class="text-gray-400 text-xs">Selecciona productos para armar tu PC</small>
              </div>

              <!-- Lista de productos seleccionados -->
              <div *ngFor="let item of productosSeleccionados" class="border border-gray-100 rounded-8 p-16 mb-16">
                <div class="d-flex align-items-start gap-12">
                  <!-- Imagen -->
                  <div class="flex-shrink-0">
                    <img
                      [src]="item.producto.imagen_principal"
                      [alt]="item.producto.nombre"
                      (error)="onImageError($event)"
                      class="w-48 h-48 object-fit-contain rounded-6 border border-gray-100"
                    />
                  </div>
                  
                  <!-- Información -->
                  <div class="flex-grow-1">
                    <h6 class="text-md mb-4 line-clamp-1">{{ item.producto.nombre }}</h6>
                    <p class="text-xs text-gray-500 mb-8">{{ item.categoria_nombre }}</p>
                    
                    <!-- Precio -->
                    <div class="d-flex justify-content-between align-items-center mb-12">
                      <span class="text-md fw-semibold text-heading">
                        S/ {{ (getPrecioNumerico(item.producto.precio_oferta || item.producto.precio) * item.cantidad).toFixed(2) }}
                      </span>
                      <small class="text-gray-500">
                        S/ {{ getPrecioNumerico(item.producto.precio_oferta || item.producto.precio).toFixed(2) }} c/u
                      </small>
                    </div>
                    
                    <!-- Controles -->
                    <div class="flex-between">
                      <!-- Cantidad -->
                      <div class="quantity d-flex align-items-center border border-gray-100 rounded-4 overflow-hidden">
                        <button
                          type="button"
                          class="quantity__minus w-32 h-32 flex-center bg-gray-50 text-gray-700 hover-bg-main-600 hover-text-white transition-2"
                          (click)="cambiarCantidadProducto(item.producto.id, item.cantidad - 1)"
                          [disabled]="item.cantidad <= 1"
                        >
                          <i class="ph ph-minus text-xs"></i>
                        </button>
                        <input
                          type="number"
                          class="quantity__input w-40 h-32 border-0 text-center text-sm fw-medium bg-white text-gray-900"
                          [value]="item.cantidad"
                          readonly
                          style="color: #000 !important;"
                        />
                        <button
                          type="button"
                          class="quantity__plus w-32 h-32 flex-center bg-gray-50 text-gray-700 hover-bg-main-600 hover-text-white transition-2"
                          (click)="cambiarCantidadProducto(item.producto.id, item.cantidad + 1)"
                        >
                          <i class="ph ph-plus text-xs"></i>
                        </button>
                      </div>
                      
                      <!-- Eliminar -->
                      <button
                        type="button"
                        class="w-32 h-32 flex-center rounded-4 bg-danger-50 text-danger-600 hover-bg-danger-600 hover-text-white transition-2"
                        (click)="removerProductoSeleccionado(item.producto.id)"
                        title="Eliminar componente"
                      >
                        <i class="ph ph-trash text-sm"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Total -->
              <div *ngIf="productosSeleccionados.length > 0" class="bg-main-50 rounded-8 p-20 mb-24">
                <div class="flex-between mb-8">
                  <span class="text-md fw-semibold">Total:</span>
                  <span class="text-lg fw-bold text-main-600">S/ {{ totalCotizacion.toFixed(2) }}</span>
                </div>
                <div class="flex-between text-sm text-gray-600">
                  <span>{{ productosSeleccionados.length }} componente(s)</span>
                  <span>Configuración personalizada</span>
                </div>
              </div>

              <!-- ✅ NUEVOS: Botones de acción con estado -->
              <div class="d-grid gap-12">
                <!-- Botón principal: depende del progreso -->
                <button
                  type="button"
                  class="btn text-white fw-semibold py-12 rounded-8"
                  [ngClass]="puedeFinalizarConfiguracion() ? 'btn-success' : 'btn-main'"
                  (click)="descargarCotizacion()"
                  [disabled]="!puedeFinalizarConfiguracion()"
                  [title]="!puedeFinalizarConfiguracion() ? 'Complete los pasos requeridos para descargar' : 'Descargar cotización completa'"
                >
                  <i [ngClass]="puedeFinalizarConfiguracion() ? 'ph ph-check' : 'ph ph-download'" class="me-8"></i>
                  {{ puedeFinalizarConfiguracion() ? 'Descargar cotización completa' : 'Complete la configuración' }}
                </button>
                
                <!-- Botón secundario -->
                <button
                  type="button"
                  class="btn btn-outline-main fw-semibold py-12 rounded-8"
                  (click)="agregarTodoAlCarrito()"
                  [disabled]="productosSeleccionados.length === 0"
                  [title]="productosSeleccionados.length === 0 ? 'Seleccione productos para agregar' : 'Agregar productos seleccionados'"
                >
                  <i class="ph ph-shopping-cart me-8"></i>
                  Agregar al carrito
                  <span *ngIf="productosSeleccionados.length > 0" class="badge bg-main-600 text-white ms-8">
                    {{ productosSeleccionados.length }}
                  </span>
                </button>

                <!-- Info adicional -->
                <div class="text-center mt-16" *ngIf="!puedeFinalizarConfiguracion()">
                  <small class="text-gray-500">
                    <i class="ph ph-info me-4"></i>
                    Complete {{ getPasosRequeridosFaltantes() }} paso(s) requerido(s) más
                  </small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<!-- =============================== Shop Section End ======================================== -->

<!-- Side Overlay for mobile sidebar -->
<div class="side-overlay"></div>
