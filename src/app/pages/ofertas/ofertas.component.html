<!-- src/app/pages/ofertas/ofertas.component.html -->
<!-- ========================= Breadcrumb Start =============================== -->
<app-breadcrumb title="Ofertas Especiales" subtitle="Productos en Oferta"></app-breadcrumb>

<!-- ========================= Breadcrumb End =============================== -->

<!-- =============================== Ofertas Section Start ======================================== -->
<section class="shop py-80">
    <div class="container container-lg">
        <div class="row">

            <!-- Sidebar Start -->
            <div class="col-lg-3">
                <div class="shop-sidebar">
                    <button type="button"
                        class="shop-sidebar__close d-lg-none d-flex w-32 h-32 flex-center border border-gray-100 rounded-circle hover-bg-main-600 position-absolute inset-inline-end-0 me-10 mt-8 hover-text-white hover-border-main-600">
                        <i class="ph ph-x"></i>
                    </button>

                    <!-- Filtro por Categoría -->
                    <div class="shop-sidebar__box border border-gray-100 rounded-8 p-32 mb-32">
                        <h6 class="text-xl border-bottom border-gray-100 pb-24 mb-24">Categorías</h6>
                        <ul class="max-h-540 overflow-y-auto scroll-sm">
                            <!-- Opción para todas las categorías -->
                            <li class="mb-24">
                                <a (click)="limpiarFiltroCategoria()"
                                   class="text-gray-900 hover-text-main-600 cursor-pointer"
                                   [class.fw-bold]="!categoriaSeleccionada">
                                    Todas las categorías ({{ totalProductos }})
                                </a>
                            </li>

                            <li class="mb-24" *ngFor="let categoria of categoriasDisponibles; let last = last"
                                [ngClass]="{ 'mb-0': last }">
                                <a (click)="seleccionarCategoria(categoria.id)"
                                   class="text-gray-900 hover-text-main-600 cursor-pointer"
                                   [class.fw-bold]="categoriaSeleccionada === categoria.id">
                                    {{ categoria.nombre }} ({{ categoria.count }})
                                </a>
                            </li>
                        </ul>
                    </div>

                    <!-- Filtro por Precio -->
                    <div class="shop-sidebar__box border border-gray-100 rounded-8 p-32 mb-32">
                        <h6 class="text-xl border-bottom border-gray-100 pb-24 mb-24">Filtrar por Precio</h6>
                        <div class="custom--range">
                            <div class="mb-3">
                                <label class="text-sm text-gray-600">Precio mínimo: S/ {{ minPrice }}</label>
                                <input
                                    type="range"
                                    class="form-range w-100"
                                    [(ngModel)]="minPrice"
                                    [min]="0"
                                    [max]="maxPrice"
                                    step="10">
                            </div>
                            <div class="mb-3">
                                <label class="text-sm text-gray-600">Precio máximo: S/ {{ maxPrice }}</label>
                                <input
                                    type="range"
                                    class="form-range w-100"
                                    [(ngModel)]="maxPrice"
                                    [min]="minPrice"
                                    [max]="10000"
                                    step="10">
                            </div>
                            <div class="flex-between flex-wrap gap-8 mt-24">
                                <button
                                    type="button"
                                    class="btn btn-main h-40 flex-align"
                                    (click)="aplicarFiltroPrecio()">
                                    Filtrar
                                </button>
                                <button
                                    type="button"
                                    class="btn btn-outline-main h-40 flex-align"
                                    (click)="limpiarFiltroPrecio()">
                                    Limpiar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Filtro por Marca -->
                    <div class="shop-sidebar__box border border-gray-100 rounded-8 p-32 mb-32">
                        <h6 class="text-xl border-bottom border-gray-100 pb-24 mb-24">Marcas</h6>
                        <ul class="max-h-540 overflow-y-auto scroll-sm">
                            <!-- Opción para todas las marcas -->
                            <li class="mb-24">
                                <div class="form-check common-check common-radio">
                                    <input
                                        class="form-check-input"
                                        type="radio"
                                        name="marca"
                                        id="marca-todas"
                                        [checked]="!marcaSeleccionada"
                                        (change)="limpiarFiltroMarca()">
                                    <label class="form-check-label" for="marca-todas">
                                        Todas las marcas
                                    </label>
                                </div>
                            </li>

                            <li *ngFor="let marca of marcasDisponibles" class="mb-24">
                                <div class="form-check common-check common-radio">
                                    <input
                                        class="form-check-input"
                                        type="radio"
                                        name="marca"
                                        [id]="'marca-' + marca.id"
                                        [checked]="marcaSeleccionada === marca.id"
                                        (change)="seleccionarMarca(marca.id)">
                                    <label class="form-check-label" [for]="'marca-' + marca.id">
                                        {{ marca.nombre }} ({{ marca.count }})
                                    </label>
                                </div>
                            </li>
                        </ul>
                    </div>

                    <!-- Botón Limpiar Filtros -->
                    <div class="shop-sidebar__box">
                        <button
                            type="button"
                            class="btn btn-outline-danger w-100"
                            (click)="limpiarFiltros()">
                            <i class="ph ph-funnel-simple me-2"></i>
                            Limpiar todos los filtros
                        </button>
                    </div>
                </div>
            </div>
            <!-- Sidebar End -->

            <!-- Content Start -->
            <div class="col-lg-9">
                <!-- Top Start -->
                <div class="flex-between gap-16 flex-wrap mb-40">
                    <span class="text-gray-900">
                        Mostrando {{ getProductosPaginados().length }} de {{ totalProductos }} ofertas
                    </span>
                    <div class="position-relative flex-align gap-16 flex-wrap">

                        <!-- List/Grid Toggle -->
                        <div class="list-grid-btns flex-align gap-16">
                            <!-- List View Button -->
                            <button type="button" class="w-44 h-44 flex-center border rounded-6 text-2xl list-btn"
                                [ngClass]="{
                                    'border-gray-100 text-gray-700': listview !== 'list',
                                    'border-main-600 text-white bg-main-600': listview === 'list'
                                }" (click)="listview = 'list'">
                                <i class="ph-bold ph-list-dashes"></i>
                            </button>

                            <!-- Grid View Button -->
                            <button type="button" class="w-44 h-44 flex-center border rounded-6 text-2xl grid-btn"
                                [ngClass]="{
                                    'border-gray-100 text-gray-700': listview !== 'grid',
                                    'border-main-600 text-white bg-main-600': listview === 'grid'
                                }" (click)="listview = 'grid'">
                                <i class="ph ph-squares-four"></i>
                            </button>
                        </div>

                        <!-- Filter (Mobile Only) -->
                        <button type="button"
                            class="w-44 h-44 d-lg-none d-flex flex-center border border-gray-100 rounded-6 text-2xl sidebar-btn">
                            <i class="ph-bold ph-funnel"></i>
                        </button>
                    </div>
                </div>
                <!-- Top End -->

                <!-- Loading -->
                <div *ngIf="isLoading" class="text-center py-5 w-100">
                    <div class="spinner-border text-main-600" role="status">
                        <span class="visually-hidden">Cargando ofertas...</span>
                    </div>
                    <p class="text-gray-500 mt-3">Cargando productos en oferta...</p>
                </div>

                <!-- Mensaje si no hay productos -->
                <div *ngIf="!isLoading && productosFiltrados.length === 0" class="text-center py-5 w-100">
                    <div class="bg-gray-50 rounded-12 py-60 px-30">
                        <i class="ph ph-tag text-6xl text-gray-300 mb-20"></i>
                        <h5 class="text-gray-700 mb-10">No hay productos en oferta</h5>
                        <p class="text-muted mb-20">Actualmente no tenemos productos con descuentos especiales</p>
                        <a [routerLink]="['/shop']" class="btn btn-main">
                            <i class="ph ph-storefront me-2"></i>
                            Ver todos los productos
                        </a>
                    </div>
                </div>

                <!-- Contenedor de productos con layout dinámico -->
                <div *ngIf="!isLoading && productosFiltrados.length > 0"
                     class="list-grid-wrapper"
                     [ngClass]="{'list-view': listview === 'list', 'grid-view': listview === 'grid'}">

                    <div *ngFor="let producto of getProductosPaginados()"
                         class="product-card p-16 border border-gray-100 hover-border-main-600 rounded-16 position-relative transition-2"
                         [class.h-100]="listview === 'grid'">

                        <a [routerLink]="['/product-details', producto.id]"
                           class="product-card__thumb flex-center rounded-8 position-relative">
                            <!-- ✅ IMAGEN CON MANEJO DE ERRORES -->
                            <img [src]="producto.imagen_principal"
                                 [alt]="producto.nombre"
                                 (error)="onImageError($event)"
                                 loading="lazy"
                                 class="product-image">

                            <!-- ✅ BADGE DE DESCUENTO -->
                            <span class="product-card__badge bg-danger-600 px-8 py-4 text-sm text-white position-absolute inset-inline-start-0 inset-block-start-0">
                                -{{ producto.descuento_porcentaje }}%
                            </span>
                        </a>

                        <div class="product-card__content mt-16">
                            <h6 class="title text-lg fw-semibold mt-12 mb-8">
                                <a [routerLink]="['/product-details', producto.id]" class="link text-line-2">
                                    {{ producto.nombre }}
                                </a>
                            </h6>

                            <!-- ✅ STOCK DISPONIBLE -->
                            <div class="mt-8 mb-12">
                                <span class="text-gray-900 text-xs fw-medium"
                                      [ngClass]="{
                                        'text-success-600': producto.stock > 10,
                                        'text-warning-600': producto.stock > 0 && producto.stock <= 10,
                                        'text-danger-600': producto.stock === 0
                                      }">
                                    <i class="ph ph-package me-1"></i>
                                    {{ producto.stock > 0 ? producto.stock + ' en Stock' : 'Sin stock' }}
                                </span>
                            </div>

                            <!-- ✅ PRECIO CON DESCUENTO Y PRECIO ORIGINAL -->
                            <div class="product-card__price my-20 d-flex flex-column gap-2">
                                <!-- Precio original tachado -->
                                <span class="text-gray-400 text-md fw-semibold text-decoration-line-through">
                                    S/ {{ producto.precio | number:'1.2-2' }}
                                </span>
                                <!-- Precio con descuento -->
                                <span class="text-md fw-semibold" style="color: #28a745;">
                                    S/ {{ producto.precio_con_descuento | number:'1.2-2' }}
                                    <span class="text-gray-500 fw-normal">/Qty</span>
                                </span>
                                <!-- Ahorro -->
                                <span class="text-xs text-success-600">
                                    Ahorras: S/ {{ (producto.precio - producto.precio_con_descuento) | number:'1.2-2' }}
                                </span>
                            </div>

                            <!-- ✅ BOTÓN AGREGAR AL CARRITO -->
                            <button
                               (click)="addToCart(producto)"
                               [disabled]="producto.stock <= 0"
                               class="product-card__cart btn bg-main-50 text-main-600 hover-bg-main-600 hover-text-white py-11 px-24 rounded-pill flex-align gap-8 mt-24 w-100 justify-content-center"
                               [ngClass]="{
                                 'bg-main-50 text-main-600 hover-bg-main-600 hover-text-white': producto.stock > 0,
                                 'bg-gray-200 text-gray-500': producto.stock <= 0
                               }">
                                <span *ngIf="producto.stock > 0">
                                    Agregar al carrito <i class="ph ph-shopping-cart"></i>
                                </span>
                                <span *ngIf="producto.stock <= 0">
                                    Sin stock <i class="ph ph-x-circle"></i>
                                </span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Pagination Start -->
                <ul *ngIf="!isLoading && productosFiltrados.length > 0 && totalPages > 1"
                    class="pagination flex-center flex-wrap gap-16 mt-40">
                    <li class="page-item">
                        <a class="page-link h-64 w-64 flex-center text-xxl rounded-8 fw-medium text-neutral-600 border border-gray-100"
                            href="javascript:void(0)" (click)="onPageChange(currentPage - 1)"
                            [class.disabled]="currentPage === 1">
                            <i class="ph-bold ph-arrow-left"></i>
                        </a>
                    </li>

                    <!-- Loop through the pages dynamically -->
                    <li *ngFor="let page of getPages()" class="page-item" [class.active]="page === currentPage">
                        <a class="page-link h-64 w-64 flex-center text-md rounded-8 fw-medium text-neutral-600 border border-gray-100"
                            href="javascript:void(0)" (click)="onPageChange(page)">
                            {{ page < 10 ? '0' + page : page }}
                        </a>
                    </li>

                    <li class="page-item">
                        <a class="page-link h-64 w-64 flex-center text-xxl rounded-8 fw-medium text-neutral-600 border border-gray-100"
                            href="javascript:void(0)" (click)="onPageChange(currentPage + 1)"
                            [class.disabled]="currentPage === totalPages">
                            <i class="ph-bold ph-arrow-right"></i>
                        </a>
                    </li>
                </ul>
                <!-- Pagination End -->
            </div>
            <!-- Content End -->

        </div>
    </div>
</section>
<!-- =============================== Ofertas Section End ======================================== -->

<!-- ========================== Shipping Section Start ============================ -->
<app-shipping></app-shipping>

<!-- ========================== Shipping Section End ============================ -->
